<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script type="text/javascript" src="JS/jquery-1.9.1.js"></script>
<script type="text/javascript" src="JS/public.js"></script>
<script  type="text/javascript" src="head.js"></script>
<script type="text/javascript" src="JS/ejs/ejs.js"></script>
<script type="text/javascript" src="JS/json2.js"></script>
<script type="text/javascript" src="JS/jquery.easyui.min.js"></script>
<script src="JS/lightbox-2.6.min.js"></script> 

<link rel="stylesheet" href="Css/public.css" type="text/css" />
<link href="css/easyui.css" rel="stylesheet" />
<link href="css/icon.css" rel="stylesheet" />
<link href="../css/font-awesome.min.css" rel="stylesheet" />
<link rel="stylesheet" href="css/lightbox.css" media="screen"/> 

<style type="text/css">
body{ background-color:#ffffff}
input[type="text"]{ width:250px; height:30px; margin:5px 5px 5px 0px; }
input[type="file"]{ width:248px; height:25px; }
.btnUpload{ width:80px;height:29px; margin-left:5px; clear:both; margin-top:15px; margin-left:90px;}
.lbCheck{ width:100px}
.lbInfo{ color:#CCC; font-size:11px}
.imgName{width:215px; height:26px; padding-top:0px; margin-top:0px; border:0px; margin-right:0px; padding-right:0px}
#main{ padding:10px 10px 10px 20px; background-color:#ffffff}
a.svn_btn3{
	padding:5px 7px;_padding:1px 2px;
	display:inline-block;
	color:#fff;
	cursor:pointer;
	font-size:12px;
	height:30px;
	width:93px;
	margin-left:3px;text-decoration:none;
}
a.svn_btn3 i{
margin-right:1px;vertical-align:middle;
}
.svn_btn3 {
	border:1px #029e4f solid;
	-webkit-box-shadow:inset 0px 0px 1px #fff;
	-moz-box-shadow:inset 0px 0px 1px #fff;
	box-shadow:inset 0px 0px 1px #fff;
	-webkit-border-radius:4px;
	-moz-border-radius:4px;
	border-radius:4px;
	text-shadow:1px 1px 0px #45a1d6;
	background-color:#0fda74;
	background-image: -webkit-gradient(linear, 0 0%, 0 100%, from(#0fda74), to(#05c263));
	background-image: -webkit-linear-gradient(top, #0fda74 0%, #05c263 100%);
	background-image: -moz-linear-gradient(top, #0fda74 0%, #05c263 100%);
	background-image: -ms-linear-gradient(top, #0fda74 0%, #05c263 100%);
	background-image: -o-linear-gradient(top, #0fda74 0%, #05c263 100%);
	background-image: linear-gradient(top, #0fda74 0%, #05c263 100%);
}
.svn_btn3:hover {
	background-color:#05c263;
	background-image: -webkit-gradient(linear, 0 0%, 0 100%, from(#05c263), to(#0fda74));
	background-image: -webkit-linear-gradient(top, #05c263 0%, #0fda74 100%);
	background-image: -moz-linear-gradient(top, #05c263 0%, #0fda74 100%);
	background-image: -ms-linear-gradient(top, #05c263 0%, #0fda74 100%);
	background-image: -o-linear-gradient(top, #05c263 0%, #0fda74 100%);
	background-image: linear-gradient(top, #05c263 0%, #0fda74 100%);
}
.fa-2x {
  font-size: 1.5em;
}
.dvImg{ float:left; width:300px; height:200px; margin-right:30px; margin-bottom:20px}
.dv1{ height:70px; margin-top:10px;height:100x; margin-bottom:30px }
.vimg{ border:3px #CCF solid }
.dvview{ height:68px; width:94px; }
.dvview2{ height:68px; width:160px; }
.dvvtop{ height:38px; width:150px; padding:5px 0px 0px 5px; }
.dv3d{ min-height:300px; margin-top:10px; background-color:#FFF }
</style>
<style type="text/css">
.stepInfo{width:300px;background:#f2f2f2;margin:0px auto 0 25px;float:left;height:0.15em;background:#bbb;font:12px/180% Arial, Helvetica, sans-serif, "新宋体"}
.stepIco{border-radius:1em;padding:0.03em;background:#bbb;text-align:center;line-height:1.5em;color:#fff; position:relative;width:18px;height:18px;top:-0.7em;float:left; }
.stepText{color:#666;margin-top:0.2em;width:4em;text-align:center;margin-left:-1.4em;}
</style>
<div id="main">
	<a href=">" id="light1" data-lightbox="example-1"></a>
    <div class="allW dv1">
	    <div class="floatL dvview vimg"><img class="allH allW" src="image/view.png" /></div>
        <div class="floatL dvview2">
        	<div class="dvvtop">
            	<div class=" floatL"><b> 实景 </b></div>
                <div style=" padding-left:14px;float:left; font-size:14px" id="imgCount"></div>
            </div>
            <div style="height:10px" onclick="upload();"><a href='#' class="svn_btn3"><i class="fa fa-upload fa-2x"></i> 上传图片</a></div>
        </div>
        <div class="floatL">
        	<div style=" height:52px; color:black; padding-top:5px; font-size:12px">
            	<div class=" floatL" style="padding-top:2px; "> 当前状态：</div>
                <div class="stepInfo floatL" id="dvState"></div>
            </div>
            <div class="" style='font:12px/180% Arial, Helvetica, sans-serif, "新宋体"'>
            	*上传店内餐桌布局图若干张，系统将为您生成3D游览图，供顾客使用。
            </div>
        </div>
    </div>
    <div id="imgAll">
        
    </div>
    <div class="allW clear">
	    <div><b>3D游览图</b></div>
    	<div id="dv3d">暂无</div>
    </div>
</div>

<!--***************Dlg内容*************************-->
<div id="dlgc" class="hide">
	<div style="padding: 20px 10px 5px 50px;">
        <div id="uploadRst" style="margin:-5px 0px 13px 0px; font-size: 12px; color: #F00; overflow: hidden; zoom: 1"> </div>
        <form class="form-horizontal" enctype='multipart/form-data' method='post' action='' role="form" id="frmUploadFile">
            <input type="file" name="files" id="File1" />
            <input type="text" name="nameUser" id="nUser" class="hide" />
            <input type="text" name="nameShop" id="nShop" class="hide" />
            <input type="text" name="nameStyle" id="nStyle" class="hide" />
            <div class="clear" style="font-size: -2; padding-top: 5px">
                <div style="border: 1px #CCC solid; width: 248px; height: 28px" class="clear floatL">
                    <div class="floatL" style="line-height: 28px">名称：</div>    
                    <input type="text" style=" width:205px; margin-top:0px" class="floatL imgName" name="name" placeholder="选填" />
                </div>
                <input type="button" class="btnUpload svn_btn3" onclick="uploadFile();" value="上传"  />
                <div style="padding-top:20px; font-size:10px; color:black; clear:both">*支持图片格式: JPG, PNG, BMP</div>
            </div>
        </form>
    </div>
</div>
<!--****************组件·IMG************************-->
<script id="tm_img" type="text/template">
<div id="img<%= id %>" title="<%= index %>" class="dvImg" style="position: relative;">
    <div style="position: absolute; width: 100%; height: 20px; z-index: 2;">
		<a style="float:right;border:1px solid #ccc;color:blue;background:#ffc;" class="easyui-splitbutton" href="javascript:void(0)" id="sbt<%= id %>" ><i class="fa fa-edit fa-lg"></i> 编辑</a>
    </div>
    <div style="position: absolute; z-index: 1">
        <img class="dvImg" id="dvImg<%= id %>" src="<%= url %>" />
    </div>
    <div id="menu<%= id %>" style="width: 50px;font-size:12px">
		<div data-options="iconCls:'icon-tip'" onclick="imgView(this);">查看</div>
        <div data-options="iconCls:'icon-cancel'" onclick="imgRemove(this);">删除</div>
    </div>
</div>
</script>
<!--****************************************-->
<div id="dlg1" style="overflow:hidden"></div>
<script language="javascript">
	var PUB_cfg=getConfig();
	var PUB_user=getUser();	
	function $$(id){ return document.getElementById(id); };
	//弹出框程序
	var htmld=dlgc.innerHTML;//存储源码
	dlgc.innerHTML="";
	var ct=0;	
	var _Max_Count=6;
	var _imgCount=0;
	var _lsIdF=new Array();//存储divId
	var _lsIdA=new Array();//存储divId
	var _data=[];
	loadImg(); //加载图片
	loadStep('dvState');	

	//************************************************************************	
	function loadStep(divId)
	{
		var data=["上传图片","系统审核","生成成功"];	
		var html="";
		for(var i=0;i<data.length;i++){
			html+='<div class="stepIco stepIco1" id="step'+ i +'">' + (i+1);
			html+='<div class="stepText" id="stext'+ i +'">'+ data[i] +'</div>';
			html+='</div>';
		}
		$j("#" + divId).html(html);
		var W=parseInt($j("#" + divId).css('width'));
		var mr=(W-18* data.length)/(data.length-1);	

		for(var i=0;i<data.length-1;i++){
			$j('#step' + i).css('margin-right', mr + 'px');			
		}
	}
	//改变进度
	function changeStep(divId,index){
		var l=$j("#" + divId).children().length;
		for(var i=0;i<=index;i++){
			$j('#step' + i).css('background', '#05c263');	
			$j("#stext" + i).css('color', '#05c263');
		}
		for(var i=index+1;i<l;i++){
			$j('#step' + i).css('background', '#bbb');	
			$j("#stext" + i).css('color', '#666');
		}
	}
	//************************************************************************
	$j("#main").parent().css("background-color","white");
	function upload(){
		document.getElementById("dlg1").innerHTML=htmld;	
		if(ct++!=0){$j('#dlg1').dialog('open');return; }
		try{
			$j("#dlg1").dialog({ 
				width:380,height:225,modal:true ,collapsible:false,title:'上传图片',minimizable:false,closable:true,draggable:false,
				onClose:function(){  
					//$j(this).dialog('destroy');    
				}    
			}).show();
		}catch(e){}
	}
	//*****************************图片处理*********************
	function imgRemove(obj){
		var str=$j(obj).parent()[0].id.toString();
		var idDiv=parseInt(str.substr(4));
		var id=parseInt($j("#img" + idDiv)[0].title);
		imgDel(id,idDiv);
	}
	function imgView(obj){
		var str=$j(obj).parent()[0].id.toString();
		var idDiv=parseInt(str.substr(4));
		var id=parseInt($j("#img" + idDiv)[0].title);
		var url=$j("#dvImg" + idDiv.toString()).attr('src');
		$j("#light1").attr('href',url);
		$j("#light1").click();
	}
	//模板获取代码
	function getHtml(id,index,url){
		var num=parseInt(id.substr(3));
		var data={id:num, index:index, url:url };
		var tm_img = document.getElementById('tm_img').innerHTML; 
		var html = ejs.render(tm_img, data);	
		$j("#imgAll").append(html); 
		$j('#sbt'+ num.toString()).splitbutton({    
			//iconCls: 'icon-edit',    
			menu: '#menu'+ num.toString()   
		}); 		
		return "";
	}
	function shopImg(data){
		_imgCount=data.length;
		var lsTemp=new Array();
		for(var i=0;i<_imgCount;i++){
			var id="img" + (i+1).toString();
			_lsIdA.push(id);
			getHtml(id, data[i].id, PUB_cfg.webURL+ "/" +data[i].url);
		}
		for(var i=_imgCount;i<_Max_Count;i++){
			var id="img" + (i+1).toString();
			_lsIdA.push(id);
			_lsIdF.push(id);
			getHtml(id, -1, "image/view.png");
		}
	}
	function getFreeId(){
		var temp={};
		for(var i=0;i<_lsIdA.length;i++)temp[_lsIdA[i]]=1;
		var index=1;
		var tp;
		while(true){
			tp=	"img" + index.toString();
			if(!temp[tp])break;
			index++;
		}
		_lsIdA.push(tp);
		return tp;
	}
	//增加
	function imgAdd(url,imgId){
		_imgCount++;
		_data.push( {id:imgId, url:url} );		
		var id;
		if(_imgCount>_Max_Count){
			//新id
			var newId=getFreeId();
			getHtml(newId, imgId, url);
		}else{
			var img=_lsIdF.shift();
			id=img.substr(3);
			$j("#dvImg" + id).attr('src', url);
			$j("#" + img).attr('title', imgId);
		}
	}
	function imgDel(imgId,divId){
		if(imgId.toString()=="-1"){
			alert("样品无需删除");
			return;
		}
		deleteFile(imgId,function(err){
			if(!err){
				var id="img" + divId;
				//查找数据
				var index=-1;
				for(var i=0;i<_data.length;i++)
					if(_data[i].id.toString()==imgId.toString()){
						index=i;
						_data.splice(index,1);
						break;
					}
				if(index<0)return;
				//删除
				if(_imgCount>_Max_Count){
					$j("#" +id).remove();
					_lsIdA.splice($j.inArray(id,_lsIdA),1);
				}else{
					_lsIdF.push(id);
					$j("#" +id).remove();
					$j(".menu-shadow").remove();
					$j("#menu" +divId).remove();
					getHtml(id, -1, "image/view.png");
				}
				_imgCount--;
			}
		});
	}	
	//加载图片数据
	function loadImg(){
		var shopId=PUB_user.shop;   //此处shopId应为当前店铺
		$j.ajax({
			url: PUB_cfg.ajaxURL + '/view',
			data: { shopId:shopId }, 
			dataType: "jsonp", type: 'get', jsonpCallback: 'callback', 
			success: function (data) {
				if(data.error==undefined){//遍历数据
					_data=data;
					var count=0;
					for(var i=0;i<data.length;i++)if(parseInt(data[i].state.toString())==3)count++;
					var step=(data.length==0)?-1:0;
					if(count>0)if(count<data.length)step=1;else step=2;
					$j('#' + 'imgCount').html(data.length + "张 / 6");
					changeStep('dvState',step);
					shopImg(_data);
				}
			},
			error: function (xhr, status, error) {
				alert("连接服务器失败");
			}
	   });
	}
	//*****************************删除文件*********************
	function deleteFile(imgId,callback){
		var id=imgId;
		var shopId=PUB_user.shop;
		$j.ajax({
			url: PUB_cfg.ajaxURL + '/delImg', 
			dataType: "jsonp", type: 'get', jsonpCallback: 'callback', 
			data: { id:id, shopId:shopId },
			success: function (RST) {
				var b=true;
				if(RST.error==undefined){
					b=false
				}else
					alert("请求失败");
				callback(b);
			},
			error: function (xhr, status, error) {	
				alert(error.message);
			}
	   	});	
	}
	function uploadFile(){
		if($$('File1').value==""){
			alert("请选择文件后上传！");
			return;
		}
		if(!isPicture( $$('File1').value ))return;
		$$("nUser").value=PUB_user.user;
		$$("nShop").value=PUB_user.shop;
		$$("nStyle").value=3;
		var formData = new FormData($j("#frmUploadFile")[0]); 
		$j.ajax({
            url: PUB_cfg.webURL + '/upload',//PUB_cfg.webURL
            type: 'POST',
            data: formData,
            async: false,
            cache: false,
            contentType: false,
            processData: false,
            success: function(data){
                if(200 === data.code) {
                    var path=data.msg.path;
                    var iName=data.msg.name;
					imgAdd(data.msg.url, data.msg.id);
                    $j("#uploadRst").html("上传成功");
                } else {
                    $j("#uploadRst").html("上传失败");
                }
            },
            error: function(xhr, status, error){alert(error);
                $j("#uploadRst").html("与服务器通信发生错误");
            }
        });
	}
	//*****************************End·上传文件******************	
</script>
<!----------------------------------------------->


<script>
	
	onload = function(){
	//**********************************请求数据
	$j.ajax({
		url: PUB_cfg.ajaxURL + '/addClass', //10.10.1.120
		dataType: "jsonp",	 
		data: { shopId:PUB_user.shop },    //附加数据请用json表示
		type: 'get',
		jsonpCallback: 'callback', 
		success: function (RST) {
			//图片数据
			if(RST.error==undefined){
				var data=RST;
				var txt="";
				for(var i=0;i<data.length;i++){
					
				}
			}else
				lb_info.innerHTML="请求失败";					
		},
		error: function (xhr, status, error) {	
			lb_info.innerHTML=error.message;
			//lb_info.innerHTML="连接服务器失败!";
		}
   	});	
	
    }  //End OnLoad
	

	
	
	
</script>

<script  type="text/javascript" src="tail.js"></script>